---
title: "Verification of Varma et al. (2024)"
subtitle: "Added analyses reported in article but missing from the public code"
author: "Original code by authors of Varma et al. (2024). Additions by Ian Hussey, Sae In Lee & Martin Götz"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_download: true
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

# Dependencies

```{r}

library(metafor)
library(papaja)
library(stringr)
library(dplyr)
library(readr) 

options(scipen=999)

```

# Dirs and data

```{r}

# Input: The master file containing all effect sizes
input_file <- "../data/processed/AllIntrusionEffectSizes.csv"

# Output: Where to save the aggregated result
output_dir <- "../data/processed/results_of_missing_analyses"

# Create output directory if it doesn't exist
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# --- Load and Prepare Data ---
df_full <- read.csv(input_file)

```

# Whole sample

## Main analysis

### Aggreated intrusion frequency across the three frequency outcome variables

Ie the result reported in the abstract and table 4a but not produced by the distributed code.

“Results showed that techniques (behavioural, pharmacological, neuromodulation) significantly reduced intrusion frequency (g = 0.16, 95% confidence interval [0.09, 0.23])”

```{r}

output_file <- file.path(output_dir, "results_aggregated_frequency_outcomes.csv")

# Filter for the aggregated "Intrusion frequency" outcome
# (This combines Diary, Lab, and Questionnaire measures)
df_overall <- df_full %>% 
  filter(DependentVariablesType == "Intrusion frequency") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_overall, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_overall$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_overall %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Main Analysis (Aggregated)",
  Outcome = "Overall Intrusion Frequency",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

# Subsets and moderators

## Immediate post

### Behavioral interventions only

```{r}

output_file <- file.path(output_dir, "results_behavioural_immediate_post_all_outcomes.csv")

# Filter for:
# 1. Behavioural interventions only (Step 3)
# 2. Immediate Post timepoint
# 3. Aggregating across ALL outcomes (no filter on DependentVariablesType)
df_subset <- df_full %>% 
  filter(Step3_Technique_procedure == "Behavioural") %>%
  filter(TimeOfManipulation == "Immediate post") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_subset, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_subset$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_subset %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Subgroup Analysis (Behavioural / Immediate)",
  Outcome = "All Outcomes Aggregated",
  Subset_Step3 = "Behavioural",
  Subset_Time = "Immediate post",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

### Imagery only

```{r}

output_file <- file.path(output_dir, "results_imagery_immediate_post_all_outcomes.csv")

# Filter for:
# 1. Behavioural interventions only (Step 3)
# 2. Immediate Post timepoint
# 3. Aggregating across ALL outcomes (no filter on DependentVariablesType)
df_subset <- df_full %>% 
  filter(Step4_Hypothesized_mechanism == "Imagery") %>%
  filter(TimeOfManipulation == "Immediate post") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_subset, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_subset$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_subset %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Subgroup Analysis (Behavioural / Immediate)",
  Outcome = "All Outcomes Aggregated",
  Subset_Step3 = "Behavioural",
  Subset_Time = "Immediate post",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

### Trauma Reminder + Tetris vs Trauma Reminder

```{r}

output_file <- file.path(output_dir, "results_tetris_immediate_post_all_outcomes.csv")

# Filter for:
# 1. Behavioural interventions only (Step 3)
# 2. Immediate Post timepoint
# 3. Aggregating across ALL outcomes (no filter on DependentVariablesType)
df_subset <- df_full %>% 
  filter(Step2_Individual_technique == "Trauma reminder + tetris vs. Trauma reminder") %>%
  filter(TimeOfManipulation == "Immediate post") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_subset, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_subset$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_subset %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Subgroup Analysis (Behavioural / Immediate)",
  Outcome = "All Outcomes Aggregated",
  Subset_Step3 = "Behavioural",
  Subset_Time = "Immediate post",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

## Delayed post

### Behavioral interventions only

```{r}

output_file <- file.path(output_dir, "results_behavioural_delayed_post_all_outcomes.csv")

# Filter for:
# 1. Behavioural interventions only (Step 3)
# 2. Immediate Post timepoint
# 3. Aggregating across ALL outcomes (no filter on DependentVariablesType)
df_subset <- df_full %>% 
  filter(Step3_Technique_procedure == "Behavioural") %>%
  filter(TimeOfManipulation == "Delayed post") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_subset, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_subset$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_subset %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Subgroup Analysis (Behavioural / Immediate)",
  Outcome = "All Outcomes Aggregated",
  Subset_Step3 = "Behavioural",
  Subset_Time = "Immediate post",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

### Imagery only

```{r}

output_file <- file.path(output_dir, "results_imagery_delayed_post_all_outcomes.csv")

# Filter for:
# 1. Behavioural interventions only (Step 3)
# 2. Immediate Post timepoint
# 3. Aggregating across ALL outcomes (no filter on DependentVariablesType)
df_subset <- df_full %>% 
  filter(Step4_Hypothesized_mechanism == "Imagery") %>%
  filter(TimeOfManipulation == "Delayed post") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_subset, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_subset$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_subset %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Subgroup Analysis (Behavioural / Immediate)",
  Outcome = "All Outcomes Aggregated",
  Subset_Step3 = "Behavioural",
  Subset_Time = "Immediate post",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

### Trauma Reminder + Tetris vs Trauma Reminder

```{r}

output_file <- file.path(output_dir, "results_tetris_delayed_post_all_outcomes.csv")

# Filter for:
# 1. Behavioural interventions only (Step 3)
# 2. Immediate Post timepoint
# 3. Aggregating across ALL outcomes (no filter on DependentVariablesType)
df_subset <- df_full %>% 
  filter(Step2_Individual_technique == "Trauma reminder + tetris") %>%
  filter(TimeOfManipulation == "Delayed post") %>%
  filter(!is.na(yi_pos) & !is.na(vi)) # Ensure valid effect sizes

# --- Run Multilevel Meta-Analysis ---
# Random effects nested: StudyID / EffectSizeID
model <- rma.mv(yi = yi_pos, 
                V = vi, 
                data = df_subset, 
                random = ~ 1 | StudyID/EffectSizeID, 
                method = "REML")

# --- Extract Results ---

# 1. Calculate Heterogeneity (Total I2)
W <- diag(1/df_subset$vi)
X <- model.matrix(model)
P <- W - W %*% X %*% solve(t(X) %*% W %*% X) %*% t(X) %*% W
total_I2 <- 100 * sum(model$sigma2) / (sum(model$sigma2) + (model$k - model$p) / sum(diag(P)))

# 2. Calculate Sample Size (N)
# Sum unique sample sizes per study to avoid double-counting within-study effects
n_participants <- df_subset %>% 
  distinct(StudyID, SampleSize) %>% 
  summarise(total_n = sum(SampleSize, na.rm = TRUE)) %>% 
  pull(total_n)

# 3. Create Results Table
results_table <- data.frame(
  Analysis = "Subgroup Analysis (Behavioural / Immediate)",
  Outcome = "All Outcomes Aggregated",
  Subset_Step3 = "Behavioural",
  Subset_Time = "Immediate post",
  N_Participants = n_participants,
  n_Experiments = model$s.nlevels[1], # Number of unique StudyIDs
  k_EffectSizes = model$k,            # Number of effect sizes
  Hedges_g = round(model$beta[1], 2),
  CI_Lower = round(model$ci.lb, 2),
  CI_Upper = round(model$ci.ub, 2),
  p_value = format.pval(model$pval, eps = 0.001),
  I2_Total = round(total_I2, 2),
  Tau2_Study = round(model$sigma2[1], 4),
  Tau2_Effect = round(model$sigma2[2], 4)
)

# --- View and Save ---
print(results_table)
write_csv(results_table, output_file)

```

List included studies

```{r}

data_tetris_delayed_fu <- df_subset |>
  select(Author, Title, Year, Journal, DOI, 
         StudyID, # multiple studies per article
         SampleSize, StudyDesign, StatExtracted, ExperimentalCondition, ComparisonCondition, 
         TimeOfManipulation,
         DVTask, ModeOfMeasurement,
         ExperimentalConditionSampleSize, ComparisonConditionSampleSize, 
         Experimental_Mean, Comparison_Mean,
         Experimental_SD, Comparison_SD,
         EffectSize, EffectSizeType,
         Notes_fromMo,
         Notes_fromSZ,
         sign, yi, vi)

data_tetris_delayed_fu

write_csv(data_tetris_delayed_fu, file.path(output_dir, "data_tetris_delayed_fu.csv"))

```

# Exploring effect sizes

```{r}

ggplot(df_full, aes(yi_pos)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 8)) +
  theme_linedraw()

```

```{r fig.height=10, fig.width=9}

df_full |>
  count(TimeOfManipulation) 

ggplot(df_full, aes(yi_pos)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 8)) +
  facet_grid(TimeOfManipulation ~ DependentVariablesType) +
  theme_linedraw()

```


```{r}

dat_key <- df_full |>
  filter(TimeOfManipulation == "Delayed post" & 
           DependentVariablesType == "Intrusion frequency") |>
  select(yi_pos, Year) |>
  arrange(yi_pos)

ggplot(dat_key, aes(yi_pos)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_histogram(binwidth = 0.1) +
  scale_x_continuous(breaks = scales::breaks_pretty(n = 8)) +
  theme_linedraw()

```


```{r fig.height=6, fig.width=9}

df_full |>
  arrange(yi_pos) |>
  mutate(rank = row_number()) |>
  ggplot(aes(yi_pos, rank)) +
  geom_point()

```

```{r}

df_full |>
  ggplot(aes(Year, yi_pos)) +
  geom_point(alpha =0.3) +
  geom_smooth(method = "lm")

dat_key |>
  ggplot(aes(Year, yi_pos)) +
  geom_point(alpha =0.3) +
  geom_smooth(method = "lm")

```



